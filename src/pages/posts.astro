---
import { Input } from "@/components/ui/input";
import { getCollection } from "astro:content";
import FormattedDate from "@/components/FormattedDate.astro";
import { SITE_TITLE } from "@/consts";
import WideLayout from "@/layouts/WideLayout.astro";
import {
  SearchIcon,
  ChevronDownIcon,
  ChevronLeftIcon,
} from "@/components/icons/icons";
import MainLayout from "@/layouts/MainLayout.astro";
import BlogPostCard from "@/components/BlogPostCard.astro";

const posts = (await getCollection("blog")).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Group posts by year
const postsByYear = posts.reduce(
  (acc, post) => {
    const year = post.data.pubDate.getFullYear();
    if (!acc[year]) {
      acc[year] = [];
    }
    acc[year].push(post);
    return acc;
  },
  {} as Record<number, typeof posts>
);

// Get sorted years (newest first)
const years = Object.keys(postsByYear)
  .map(Number)
  .sort((a, b) => b - a);
---

<WideLayout
  title={`Blog Posts - ${SITE_TITLE}`}
  description="Browse and search all blog posts"
>
  <div class="mb-10 max-w-2xl mx-auto">
    <div class="mb-2">
      <div class="relative">
        <Input type="text" placeholder="Search posts..." id="searchInput" />
        <SearchIcon
          className="absolute right-6 top-1/2 transform -translate-y-1/2 w-6 h-6 text-muted-foreground"
        />
      </div>
    </div>

    <!-- Tag Filters -->
    <div class="w-full overflow-x-auto">
      <div class="flex space-x-2 p-4 min-w-max">
        <button
          class="tag-filter active inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 transition-colors flex-shrink-0 cursor-pointer"
          data-tag=""
        >
          All Posts
        </button>
        {
          posts
            .flatMap((post) => post.data.tags || [])
            .filter((tag, index, arr) => arr.indexOf(tag) === index)
            .sort()
            .map((tag) => (
              <button
                class="tag-filter inline-flex items-center px-4 py-2 rounded-full text-sm font-medium bg-muted text-muted-foreground hover:bg-muted/80 hover:text-foreground transition-colors cursor-pointer text-nowrap capitalize flex-shrink-0"
                data-tag={tag}
              >
                {tag}
              </button>
            ))
        }
      </div>
    </div>
  </div>

  <section>
    <div class="space-y-6 max-w-2xl mx-auto" id="results">
      {
        years.map((year) => (
          <div class="year-section">
            <button
              class="year-toggle flex items-center gap-4 mb-6 w-full text-left hover:opacity-80 transition-opacity cursor-pointer"
              data-year={year}
            >
              <h2 class="text-sm text-muted-foreground">{year}</h2>
              <div class="h-px bg-border flex-1" />
              <ChevronDownIcon
                size={16}
                className="chevron-icon transition-transform duration-200 text-muted-foreground"
              />
            </button>

            <div class="year-posts" data-year-content={year}>
              {postsByYear[year].map((post) => (
                <BlogPostCard
                  post={post}
                  variant="compact"
                  data-post={JSON.stringify({
                    title: post.data.title.toLowerCase(),
                    description: post.data.description.toLowerCase(),
                    tags: (post.data.tags || []).map((tag) =>
                      tag.toLowerCase()
                    ),
                    slug: post.id,
                    year: year,
                  })}
                />
              ))}
            </div>
          </div>
        ))
      }
    </div>
  </section>

  <!-- No Results Message -->
  <div class="text-center py-16 hidden" id="noResults">
    <div class="flex justify-center items-center flex-col">
      <div class="text-6xl mb-4 mx-auto text-muted-foreground">
        <SearchIcon width={70} height={70} />
      </div>
      <h3 class="text-2xl font-semibold text-foreground mb-2">
        No posts found
      </h3>
      <p class="text-muted-foreground">
        Try adjusting your search criteria or browse all posts.
      </p>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById(
      "searchInput"
    ) as HTMLInputElement;
    const results = document.getElementById("results") as HTMLElement;
    const noResults = document.getElementById("noResults") as HTMLElement;
    const tagFilters = document.querySelectorAll(".tag-filter");
    const postItems = document.querySelectorAll(".post-item");
    const yearToggleButtons = document.querySelectorAll(".year-toggle");
    const yearSections = document.querySelectorAll(".year-section");

    let currentTag = "";

    // Year toggle functionality
    yearToggleButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const year = button.getAttribute("data-year");
        const yearContent = document.querySelector(
          `[data-year-content="${year}"]`
        );
        const yearSection = button.closest(".year-section");
        const chevronIcon = button.querySelector(".chevron-icon");

        if (yearContent && yearSection && chevronIcon) {
          const isCollapsed = yearContent.classList.contains("hidden");

          if (isCollapsed) {
            yearContent.classList.remove("hidden");
            chevronIcon.classList.remove("-rotate-90");
            chevronIcon.classList.add("rotate-0");
          } else {
            yearContent.classList.add("hidden");
            chevronIcon.classList.remove("rotate-0");
            chevronIcon.classList.add("-rotate-90");
          }
        }
      });
    });

    // Check for URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const tagParam = urlParams.get("tag");
    const queryParam = urlParams.get("q");

    if (queryParam && searchInput) {
      searchInput.value = queryParam;
    }

    if (tagParam) {
      currentTag = tagParam;
      tagFilters.forEach((filter) => {
        filter.classList.remove("active");
        filter.classList.remove("bg-primary", "text-primary-foreground");
        filter.classList.add("bg-muted", "text-muted-foreground");

        if (filter.getAttribute("data-tag") === tagParam) {
          filter.classList.add("active");
          filter.classList.remove("bg-muted", "text-muted-foreground");
          filter.classList.add("bg-primary", "text-primary-foreground");
        }
      });
    }

    function filterPosts() {
      if (!searchInput) return;
      const query = searchInput.value.toLowerCase().trim();
      let visibleCount = 0;
      const yearVisibility: Record<string, number> = {};

      postItems.forEach((item) => {
        const dataPost = item.getAttribute("data-post");
        if (!dataPost) return;

        const postData = JSON.parse(dataPost);
        const matchesSearch =
          !query ||
          postData.title.includes(query) ||
          postData.description.includes(query) ||
          postData.tags.some((tag: string) => tag.includes(query));

        const matchesTag =
          !currentTag || postData.tags.includes(currentTag.toLowerCase());

        const shouldShow = matchesSearch && matchesTag;

        (item as HTMLElement).style.display = shouldShow ? "block" : "none";
        if (shouldShow) {
          visibleCount++;
          const year = postData.year.toString();
          yearVisibility[year] = (yearVisibility[year] || 0) + 1;
        }
      });

      // Show/hide year sections based on whether they have visible posts
      yearSections.forEach((section) => {
        const yearToggle = section.querySelector(".year-toggle") as HTMLElement;
        const year = yearToggle?.getAttribute("data-year");

        if (year) {
          const hasVisiblePosts = yearVisibility[year] > 0;
          (section as HTMLElement).style.display = hasVisiblePosts
            ? "block"
            : "none";
        }
      });

      if (results) results.style.display = visibleCount > 0 ? "block" : "none";
      if (noResults) {
        noResults.classList.toggle("hidden", visibleCount > 0);
        noResults.classList.toggle("block", visibleCount === 0);
      }
    }

    if (searchInput) {
      searchInput.addEventListener("input", filterPosts);
    }

    tagFilters.forEach((filter) => {
      filter.addEventListener("click", () => {
        tagFilters.forEach((f) => {
          f.classList.remove("active");
          f.classList.remove("bg-primary", "text-primary-foreground");
          f.classList.add("bg-muted", "text-muted-foreground");
        });

        filter.classList.add("active");
        filter.classList.remove("bg-muted", "text-muted-foreground");
        filter.classList.add("bg-primary", "text-primary-foreground");

        currentTag = filter.getAttribute("data-tag") || "";
        filterPosts();
      });
    });

    // Initial filter on page load
    filterPosts();
  </script>
</WideLayout>
